name: Build Android APK

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type (apk or aab)'
        required: true
        default: 'apk'
        type: choice
        options:
        - apk
        - aab

jobs:
  build:
    name: Build Android App
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
    - name: ğŸ— Setup repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ— Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: npm

    - name: ğŸ— Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: ğŸ— Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: ğŸ— Setup Expo and EAS
      uses: expo/expo-github-action@v8
      with:
        expo-version: latest
        eas-version: latest
        token: ${{ secrets.EXPO_TOKEN }}

    - name: ğŸ“¦ Install dependencies
      run: |
        npm ci --prefer-offline --no-audit
        npx expo install --fix
        # Ensure TypeScript and all dev dependencies are properly installed
        npm install --only=dev
        # Verify critical dependencies
        npx tsc --version
        echo "Dependencies installed successfully"

    - name: ğŸ”§ Verify EAS CLI
      run: |
        npx eas-cli --version
        echo "EAS CLI verified successfully"

    - name: ğŸ” Verify project configuration
      run: |
        echo "Checking project configuration..."
        npx expo-doctor --fix-dependencies
        npx tsc --noEmit || echo "TypeScript check completed"
        echo "Project verification completed"

    - name: ğŸ— Setup Gradle cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: ğŸ”§ Setup build environment
      run: |
        echo "EXPO_NO_TELEMETRY=1" >> $GITHUB_ENV
        echo "EXPO_NO_GIT_STATUS=1" >> $GITHUB_ENV
        echo "EAS_NO_VCS=1" >> $GITHUB_ENV
        mkdir -p ./build-output

    - name: ğŸš€ Build APK
      if: github.event.inputs.build_type == 'apk' || github.event.inputs.build_type == ''
      run: |
        echo "Building APK with preview profile..."
        npx eas-cli build --platform android --profile preview --local --output ./build-output/app.apk --non-interactive --clear-cache
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        EAS_NO_VCS: 1
        NODE_ENV: production

    - name: ğŸš€ Build AAB
      if: github.event.inputs.build_type == 'aab'
      run: |
        echo "Building AAB with production profile..."
        npx eas-cli build --platform android --profile production --local --output ./build-output/app.aab --non-interactive --clear-cache
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        EAS_NO_VCS: 1
        NODE_ENV: production

    - name: ï¿½ Verify build output
      run: |
        echo "Checking build output directory..."
        ls -la ./build-output/ || echo "Build output directory not found"
        if [ -f "./build-output/app.apk" ]; then
          echo "âœ… APK build found: $(ls -lh ./build-output/app.apk)"
        fi
        if [ -f "./build-output/app.aab" ]; then
          echo "âœ… AAB build found: $(ls -lh ./build-output/app.aab)"
        fi

    - name: ï¿½ğŸ“¦ Upload APK artifact
      if: github.event.inputs.build_type == 'apk' || github.event.inputs.build_type == ''
      uses: actions/upload-artifact@v4
      with:
        name: android-apk-${{ github.sha }}
        path: ./build-output/app.apk
        retention-days: 30

    - name: ğŸ“¦ Upload AAB artifact
      if: github.event.inputs.build_type == 'aab'
      uses: actions/upload-artifact@v4
      with:
        name: android-aab-${{ github.sha }}
        path: ./build-output/app.aab
        retention-days: 30

    - name: ğŸ“Š Build summary
      run: |
        echo "## ğŸ‰ Build Completed Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Details:" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Type:** ${{ github.event.inputs.build_type || 'apk' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“± **Download the built app from the Artifacts section above.**" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: build
    if: always()
    steps:
    - name: ğŸ“± Build Success Notification
      if: needs.build.result == 'success'
      run: |
        echo "âœ… Android build completed successfully!"
        echo "ğŸ“± APK/AAB is ready for download from artifacts."

    - name: âŒ Build Failure Notification
      if: needs.build.result == 'failure'
      run: |
        echo "âŒ Android build failed!"
        echo "Please check the logs for details."
